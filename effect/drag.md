# JS实现拖拽

> 这次我们来玩一下JS一些效果的实现，来认识一下JS可能有什么用处。首先第一个就来看看JS怎么实现简单的拖拽吧。

首先要解决三个问题：

1. 元素怎么移动
2. 元素开始与停止拖拽
3. 元素移动的距离计算

我用的是绝对定位（absolute）来控制元素的移动的。因为这个还是比较好控制的，只要控制top，left就能控制元素的移动了。

我们是通过点击某个元素开始拖拽，然后移动鼠标开始移动，最后松开鼠标停止拖拽。点击与松开都有对应的事件来控制：onmousedown和onmouseup。所以当onmousedown触发时，我们给目标元素一个属性值为true，表示它可以移动。在onmouseup事件触发时候，我们将这个属性值设置为false，表示不能拖拽了。

onmousemove事件是当鼠标在该元素上面移动时，会一直触发的（当停止在元素上面时不会触发）。所以第三个问题可以在该事件里解决。当元素可以移动时，我们计算top与left的值，然后重新赋值给目标元素，它就会移动了。

这个top怎么计算呢？我们来看看什么东西是不会变的。

因为是使用绝对定位了目标元素，它会有一个包含块，它会在该包含块内移动。我们称它为一个框吧。这个框的位置是不会变的，也就是说这个框的padding-box（内容区域加padding区域）的左上角距离页面的最上方与最左方的距离是不会变的，所以下面的结果是不会变的：

<pre>
<code>
event.pageY - ele.style.top
</code>
</pre>

鼠标的pageY（鼠标在页面上的纵坐标）减去事件目标的css的top属性值就等于上面所说padding-box的左上角距离页面的最上方的距离。这个结果是不会变的（除非这个框移动了）。我们知道一开始的ele.style.top值与event.pageY的值，在移动过程中我们也可以知道变化了的event.pageY值，所以当然也知道移动过程中的ele.style.top的值拉，同理left也是这样算的。

基本的原理知道了，那么编写程序就是小意思了。不过在这个过程中，还出现了下面的一些问题，我们一个一个解决掉它们。

### 拖拽过程中鼠标离开目标元素

这是之前让我放弃的一个问题。。。还好受到了一篇博客的启发，终于搞定了。

#### 问题描述：

当我们拖拽过程中，触发一次onmousemove事件，元素才会移动一次。当鼠标移动速度过快，一下子离开了目标元素，那么就触发不了目标元素的onmousemove事件了，也就拖动不了了。如果我们这时候松开鼠标，目标元素还是可拖拽的（因为没有触发目标元素的onmouseup事件），当鼠标又划过目标元素时，它又能被拖拽了。这都不是我们想要的结果。

#### 解决方法：

监听body的onmouseup与onmousemove事件，而不是目标元素的onmousemove与onmouseup事件。监听body的onmousemove可以使当鼠标离开目标元素时目标元素还能被拖拽。监听body的onmouseup可以使当在body上松开鼠标时，也能将目标元素设置为不可拖拽。这时候我不设置目标元素的可拖拽属性了，而是设置一个全局变量target，初始化为undefined（不赋值）。当目标元素被触发onmousedown事件时，将target赋值为目标元素。当body的onmousemove事件触发时，查看target是否指向某个目标元素，若是，则移动目标元素，否则什么也不做。当body的onmouseup事件触发时，则将target赋值为null，就不会有元素被拖动了。

### 限定某个区域

#### 问题描述：

让目标元素只能在某个矩形区域内移动。

#### 解决方法

因为我是使用绝对定位来控制移动的，所以这个矩形区域只能是目标元素的包含快。那么问题的解决也很简单了，让top不能小于0与不能大于padding-box的高减去目标元素的高，让left不能小于0与不能大于padding-box的宽减去目标元素的宽，padding-box指的就是目标元素所在包含块的的元素的padding-box。那这个padding-box的宽与高可以怎么算？其实clientWidth与clientHeight即是padding-box的宽与高，问题就这么解决了。

#### 其他注意事项

因为在body上监听了事件，所以我们要将body的范围扩充到整个浏览器视口（body的高是根据子元素的高度来确定的，可能有时候并不会占据整个浏览器视口），可以加上以下的CSS：

<pre>
<code>
html,body{
  height: 100%;
}
</code>
</pre>

绝对定位可能有点限制我们，大家可以尝试一下其他控制移动的方法。

### 总结

终于开始学习一下JS的网页效果的一些实现了，因为这应该是JS刚开始出现时要干的事情，掌握一下基本的效果的实现思路也是必要的。在本文中我基本没有展示我的核心的代码，因为我觉得最重要的是一个思路与思考过程（实际上是代码潦草了，没有信心让别人看理解）。
