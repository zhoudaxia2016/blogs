##  聊天室实现

> 用了三天时间实现了一个简单的聊天室，起了个名字叫[liaoliao](liaoliao.maozzhou.cn)。也算一次简单的实践！[代码地址](https://github.com/zhoudaxia2016/liaoliao)

我觉得学习应该有两个方向，一个是在实践中学习，一个是在基础中学习，两者的关系是密不可分的。如果只在基础中学习，不参与实践的话，学习是没有动力与进展的，思维会被限制，而实践是发现问题，拓展经验的重要的方法，只在基础中学习是很难发现问题的。而只在实践中学习的话，也是会限制我们的自由的，因为在一个项目中总会陷入仅利用已经学会的知识来完成这个项目，不敢尝试新的技术，新的方法。

前面可以当作是废话一堆，接下来说一下在完成这个聊天室遇到的困难与总结的经验吧。

### 确定方法

聊天室可以怎么实现呢？怎么实现多人接收信息呢？可能会有websocket，ajax轮询的方法。因为轮询的方法比较简单，所以我就选择了它，现在还没尝试过websocket（这就是我刚刚说的不敢尝试）。

轮询是什么意思？又是一个包装了高级名字概念。轮询就是不停地问有消息没有？ajax轮询就是在客户端设置一个计时器，不停地向服务器发送请求，这样才能不漏掉别人发出的信息。别人发出的信息都保存在服务器上面。

轮询扩展出来的概念还有长轮询，就是在轮询的基础上，不过是等服务器返回了信息才再发起下一次请求，而不是不停的发送请求。

websocket是html5的api，以后再详细学习它。

因为在前端使用vuejs需要打包工具，所以前台没有使用框架，后端使用了nodejs的框架express，应该是第一次使用它来完成一个项目。后端还使用了ejs模板引擎。

### 步骤

liaoliao只有两个简单的页面，一个是登陆页面，一个是聊天页面。因为还不熟悉数据库，所以数据都保存在内存中，虽然这样会出现很多弊端。数据有：用户列表，信息列表

#### 登陆

为了简化登陆，登陆只需要填名字与选一个头像就好了。在启动服务器的时候，首先会扫描看看有多少张头像图片，然后将头像都展示到登陆页面上，供用户选择。当用户选择了一个头像，登陆的时候也会将该头像的id（其实就是头像图片的名字，一个数字）post到服务器，然后将用户push到用户列表。最后还要在session记录一个user\_id的值，表示已经登陆。

然后聊天页面实现了三个基本功能：发送信息，接受信息与用户列表显示。

#### 发送信息

发送信息其实很简单，直接post信息到服务器，然后根据user\_id确定是谁发来的，将信息push到信息列表。

#### 接受信息

这就得用到轮询了。客户端会不停的发送请求到服务器问：有人发信息吗？我使用的时间间隔是每秒发送一次，效果还好，没有明显感觉到延迟。不能每一次请求都返回一个信息列表，这样会浪费时间与空间的。所以在用户列表中的每一个用户还有一个属性last，表示最后一条信息是第几条，如果小于信息列表的长度，则信息列表肯定更新了，则需要发送新的信息到该用户。这里需要用到express处理JSON数据的插件body-parser。

#### 用户列表

这个咋一看还和上面的问题差不多，可是实际上用户列表可能更加复杂，因为可能会有用户退出，所以就不能以长度来判断是否更新了。所以我在每个用户都保存一个布尔值，表示用户列表是否更新了。一开始这个值为false。当有用户退出或者登陆时，都会将所有用户的这个值置为true，通知告诉它们需要更新用户列表了！还要添加用户列表的轮询。

#### 遇到的问题

上面还没有说到的退出是一个最大的问题。首先我就是将目标投向移动端的，可是移动端的onbeforeunload出现了问题（在离开该页面会触发的事件），并没有触发它。所以造成的问题就是一堆用户没有退出，但是它们已经离开了该页面。

最后我只能用一个退出按钮来实现退出登陆。以后再深入研究移动端的处理页面离开的问题。

#### 总结

其实这只是实现了简单的功能，如果还有兴趣的话再添加发送表情，两个人聊天的功能。

通过这次小项目，我终于知道实践是发现问题最好的方法，只有发现了问题才能进步！
